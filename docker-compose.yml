# Docker Compose configuration for Dynamic Agent Marketplace Platform
# Usage: docker-compose up --build

version: '3.8'

services:
  # Computer Use Container (provides screenshot, mouse, keyboard API)
  computer-use:
    build:
      context: .
      dockerfile: Dockerfile.computer-use
    container_name: computer-use
    ports:
      - "8080:8080"  # API endpoint
      - "5900:5900"  # VNC access (optional, for debugging)
    environment:
      - DISPLAY=:99
      - DISPLAY_WIDTH=1920
      - DISPLAY_HEIGHT=1080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - agent-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  # API Container (Dynamic Agent with MCP, S3 Skills, Native Tools)
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: dynamic-agent-api
    ports:
      - "8003:8003"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - COMPUTER_USE_CONTAINER_URL=http://computer-use:8080
      - AWS_REGION=us-west-2
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - S3_BUCKET=cerebricks-studio-agent-skills
    volumes:
      - ./.claude:/app/.claude:ro
    depends_on:
      computer-use:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - agent-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

networks:
  agent-network:
    driver: bridge
